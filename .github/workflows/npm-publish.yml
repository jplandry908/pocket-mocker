name: NPM Publish

on:
  release:
    types: [published]

jobs:
  npm-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      - name: TypeScript type check
        run: npm run check

      - name: Build package
        run: npm run build

      - name: Verify package files
        run: |
          echo "Files to be published:"
          npm pack --dry-run
          echo "Package size:"
          du -sh *.tgz

      - name: Publish to NPM with retry
        run: |
          # Retry function
          publish_with_retry() {
            local max_attempts=3
            local attempt=1
            local delay=30

            while [ $attempt -le $max_attempts ]; do
              echo "Publish attempt $attempt of $max_attempts..."

              if npm publish --access public --verbose; then
                echo "âœ… Package published successfully!"
                return 0
              else
                echo "âŒ Publish attempt $attempt failed"

                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting ${delay}s before retry..."
                  sleep $delay
                  delay=$((delay * 2))  # Exponential backoff
                fi

                attempt=$((attempt + 1))
              fi
            done

            echo "ðŸš¨ All publish attempts failed"
            return 1
          }

          # Execute publish with retry
          publish_with_retry
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Wait for NPM registry update
        run: |
          echo "Waiting for NPM registry to update..."
          sleep 30

      - name: Verify package on NPM
        run: |
          # Get package name from package.json
          PACKAGE_NAME=$(jq -r '.name' package.json)
          PACKAGE_VERSION=$(jq -r '.version' package.json)

          # Verify package exists on NPM
          for i in {1..5}; do
            echo "Verification attempt $i of 5..."

            if npm view $PACKAGE_NAME@$PACKAGE_VERSION > /dev/null 2>&1; then
              echo "âœ… Package $PACKAGE_NAME@$PACKAGE_VERSION is available on NPM"
              echo "ðŸ“¦ Package info:"
              npm view $PACKAGE_NAME@$PACKAGE_VERSION
              break
            else
              if [ $i -lt 5 ]; then
                echo "Package not yet visible, waiting 30s..."
                sleep 30
              else
                echo "âš ï¸ Warning: Package not visible on NPM after all attempts"
                echo "This might be a propagation delay. Check manually later."
              fi
            fi
          done

      - name: Create rollback plan file
        if: failure()
        run: |
          PACKAGE_NAME=$(jq -r '.name' package.json)
          PACKAGE_VERSION=$(jq -r '.version' package.json)
          PREV_VERSION=$(npm view $PACKAGE_NAME version 2>/dev/null || echo "unknown")

          cat > rollback_info.md << EOF
          # Rollback Information

          **Failed Operation**: Publish $PACKAGE_NAME@$PACKAGE_VERSION
          **Timestamp**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Previous Version**: $PREV_VERSION

          ## Rollback Steps (if needed):

          1. **If package was partially published**:
             \`\`\`bash
             npm unpublish $PACKAGE_NAME@$PACKAGE_VERSION --force
             \`\`\`

          2. **Publish previous stable version** (if necessary):
             \`\`\`bash
             npm publish --tag latest  # from the previous stable commit
             \`\`\`

          3. **Verify NPM registry**:
             \`\`\`bash
             npm view $PACKAGE_NAME
             \`\`\`

          ## Check List:
          - [ ] Verify package status on npmjs.com
          - [ ] Check GitHub release status
          - [ ] Notify users if necessary
          - [ ] Update documentation if needed
          EOF

          echo "Rollback information saved to rollback_info.md"
          cat rollback_info.md

      - name: Update documentation links (if needed)
        run: |
          echo "Checking if documentation needs updates..."
          # This step can be customized based on your documentation needs
          # For example, updating version numbers in README.md

      - name: Notify team (optional)
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… NPM publish completed successfully!"
            echo "ðŸ“¦ Package: $(jq -r '.name' package.json)@$(jq -r '.version' package.json)"
          else
            echo "âŒ NPM publish failed. Check logs for details."
            echo "ðŸ”„ Rollback information has been generated."
          fi